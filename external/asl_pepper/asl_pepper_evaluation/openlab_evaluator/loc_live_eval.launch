<?xml version="1.0"?>
<launch>
  <arg name="rosbag" default="corridor_koze_kids" />
  <arg name="mapname" default="openlab_office_j" />
  <arg name="mapfolder" default="$(env HOME)/maps"/>
  <arg name="script_args" default=""/>
  <arg name="start_time" default="0."/>
  <arg name="duration" default="60."/>
  <arg name="rviz" default="true"/>
  <param name="/rosbag_name" value="$(arg rosbag)" />

  <arg name="localization" default="true"/>

  <!-- Rosbag -->
  <include file="$(find asl_pepper_rosbags)/launch/launch_rosbag_v2.launch">
    <arg name="rosbag_path" value="$(env HOME)/rosbags/openlab_rosbags/$(arg rosbag).bag" />
<!--   <include file="$(env HOME)/launch_rosbag_demo2.launch"> -->
<!--     <arg name="rosbag_path" value="$(env HOME)/rosbags/$(arg rosbag).bag" /> -->
    <arg name="start_time" value="$(arg start_time)" />
    <arg name="duration" value="$(arg duration)" />
  </include>
  <include file="$(find pepper_description)/launch/pepper_upload.launch" if="$(eval arg('rosbag') != 'simulator')"/>

  <!-- Gmapping & Map Matching -->
  <include file="$(find asl_pepper_gmapping)/launch/gmapping.launch" if="$(arg localization)">
    <arg name="output" value="log"/>
    <arg name="map_frame" value="/eval_gmap"/>
    <arg name="map_topic" value="/eval_gmap"/>
  </include>
  <include file="$(find map_matcher)/launch/map_matcher.launch" if="$(arg localization)">
    <arg name="acceptance_ratio" value="0.2" />
    <arg name="output" value="screen" />
    <arg name="slam_map_topic" value="/eval_gmap"/>
    <arg name="reference_map_name" value="$(arg mapname)"/>
    <arg name="reference_map_frame" value="/eval_reference_map"/>
    <arg name="maps_folder" value="$(arg mapfolder)"/>
  </include>
  <!-- Otherwise just publish reference map -->
  <node pkg="map_server" type="map_server" name="ref_map_server_2"
    args="$(arg mapfolder)/$(arg mapname).yaml" 
    >
<!--     if="$(eval arg('localization') != true)"> -->
    <param name="frame_id" value="reference_map" />
    <remap from="/map" to="/reference_map"/>
  </node>

  <!-- Evaluation script -->
  <node pkg="asl_pepper_evaluation" type="loc_live_eval" name="loc_live_eval" output="screen"
    args="$(arg script_args)" required="true">
    <param name="reference_map_name" value="$(arg mapname)"/>
    <param name="reference_map_folder" value="$(arg mapfolder)"/>
  </node>
  <!-- ros_run_command does not forward node namespace to script, so the script gets param from absolute namespace /python_planner/PARAM_NAME -->

  <node type="rviz" name="rviz" pkg="rviz" args="-d $(env HOME)/.rviz/localization.rviz" output="log" if="$(arg rviz)"/>
</launch>


